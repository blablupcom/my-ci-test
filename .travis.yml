env:
  global:
    # This URL redirects to https://proofwiki.org/wiki/Main_Page ,
    # which changes protocol and hostname, and only supports TLSv1.2
    URL=http://www.proofwiki.org/wiki/Main_Page

matrix:
  include:
    # OK
    - env: DIST=precise SUDO=false BUILD=gnutls TEST_PYTHON=1
      os: linux
      dist: precise
      sudo: false
      language: python
      python: 3.4
      addons:
        apt:
          packages:
            - nettle-dev

install:
    - if [[ "$APT" == "everything-debian-sid-wget" || "$APT" == "everything" || "$APT" == "debian-sid-everything" ]]; then
        sudo apt-get -qq update ;
        sudo apt-get -yf -o Dpkg::Options::="--force-confold" upgrade ;
      fi
    - if [[ "$APT" == "everything-debian-sid-wget" ]]; then
        curl -sSL "https://ftp-master.debian.org/keys/archive-key-7.0.asc" | sudo -E apt-key add - ;
        echo "deb http://ftp.us.debian.org/debian unstable main contrib non-free" | sudo tee -a /etc/apt/sources.list > /dev/null ;
        sudo apt-get -qq update ;
        sudo apt-get -yf install wget ;
      fi
    - if [[ "$BUILD" == "gnutls" ]]; then
        wget http://ftp.gnu.org/gnu/gnutls/gnutls-3.1.5.tar.xz ;
        tar -xJf gnutls-3.1.5.tar.xz ;
        cd gnutls-3.1.5 ;
        ./configure --prefix=$HOME/gnutls ;
        make install ;
        cd .. ;
        export LD_LIBRARY_PATH=$HOME/gnutls/lib:$LD_LIBRARY_PATH
      fi
    - if [[ "$BUILD" == "wget" ]]; then
        wget http://ftp.gnu.org/gnu/wget/wget-1.17.tar.xz ;
        tar -xJf wget-1.17.tar.xz ;
        cd wget-1.17 ;
        ./configure ;
        sudo make install ;
        cd .. ;
      fi
    - if [[ "$TEST_PYTHON" == 1 || "$TEST_URLLIB3_EXPLICIT" == 1 || "$TEST_REQUESTS_EXPLICIT" == 1 ]]; then
        pip install "urllib3[secure]" "requests[security]" ;
      fi

before_script:
    - env
    - python --version
    - wget --version
    - curl --version
    - curl --help

script:
    - if [[ "$TEST_PYTHON" == 1 ]]; then
        python -c "import requests; print(requests.get('$URL').status_code);" ;
      fi
    - if [[ "$TEST_URLLIB3_EXPLICIT" == 1 ]]; then
        python -c "import ssl, urllib3; r = urllib3.PoolManager(ssl_version=ssl.PROTOCOL_TLSv1_2).request('GET', '$URL'); print(r.status);" ;
      fi
    - if [[ "$TEST_REQUESTS_EXPLICIT" == 1 ]]; then
        python requests_explicit.py "$URL" ;
      fi
    - if [[ "$TEST_WGET" == 1 ]]; then
        wget $URL ;
      fi
    - if [[ "$TEST_WGET_EXPLICIT" == 1 ]]; then
        wget --secure-protocol=TLSv1_2 $URL ;
      fi
    - if [[ "$TEST_CURL" == 1 ]]; then
        curl -v $URL ;
      fi
    - if [[ "$TEST_CURL_EXPLICIT" == 1 ]]; then
        curl -v --tlsv1.2 $URL ;
      fi
